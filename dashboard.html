<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LunaProjectX - Dashboard</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <h1>Dashboard</h1>
  <p>Welcome, <span id="user-nickname"></span>!</p>
  <button onclick="logout()">Logout</button>

  <h2>Upload File</h2>
  <input type="file" id="file-input">
  <button onclick="uploadFile()">Upload</button>

  <!-- Polyglot Maker Video -->
  <h2>Polyglot Maker (PNG + MP4)</h2>
  <div>
    <label>Cover Gambar (JPG/PNG/WEBP ≤ 100 MB):</label><br>
    <input type="file" id="pngVideo" accept="image/*"><br><br>
    <label>Video MP4 (≤ 100 MB):</label><br>
    <input type="file" id="mp4File" accept="video/mp4"><br><br>
    <button onclick="makePolyglot('pngVideo','mp4File','video')">Buat Polyglot</button>
    <a id="downloadVideo" style="display:none;" download="polyglot.png">Download Hasil</a>
    <div id="progressBoxVideo" style="display:none; margin-top:10px;">
      <div class="progress"><div class="bar" id="progressBarVideo"></div></div>
      <p id="progressTextVideo">Progress: 0%</p>
    </div>
    <div id="messageVideo" style="display:none;"></div>
    <button id="backToTopVideo" onclick="scrollToTop()">⬆ Kembali ke Atas</button>
  </div>

  <!-- Polyglot Maker Dokumen -->
  <h2>Polyglot Maker (PNG + Dokumen)</h2>
  <div>
    <label>Cover Gambar (JPG/PNG/WEBP ≤ 100 MB):</label><br>
    <input type="file" id="pngDoc" accept="image/*"><br><br>
    <label>File Dokumen (≤ 100 MB):</label><br>
    <input type="file" id="docFile" accept="*/*"><br><br>
    <button onclick="makePolyglot('pngDoc','docFile','doc')">Buat Polyglot</button>
    <a id="downloadDoc" style="display:none;" download="polyglot.png">Download Hasil</a>
    <div id="progressBoxDoc" style="display:none; margin-top:10px;">
      <div class="progress"><div class="bar" id="progressBarDoc"></div></div>
      <p id="progressTextDoc">Progress: 0%</p>
    </div>
    <div id="messageDoc" style="display:none;"></div>
    <button id="backToTopDoc" onclick="scrollToTop()">⬆ Kembali ke Atas</button>
  </div>

  <!-- Polyglot Maker Audio -->
  <h2>Polyglot Maker (PNG + Audio)</h2>
  <div>
    <label>Cover Gambar (JPG/PNG/WEBP ≤ 100 MB):</label><br>
    <input type="file" id="pngAudio" accept="image/*"><br><br>
    <label>File Audio (≤ 100 MB):</label><br>
    <input type="file" id="audioFile" accept="audio/*"><br><br>
    <button onclick="makePolyglot('pngAudio','audioFile','audio')">Buat Polyglot</button>
    <a id="downloadAudio" style="display:none;" download="polyglot.png">Download Hasil</a>
    <div id="progressBoxAudio" style="display:none; margin-top:10px;">
      <div class="progress"><div class="bar" id="progressBarAudio"></div></div>
      <p id="progressTextAudio">Progress: 0%</p>
    </div>
    <div id="messageAudio" style="display:none;"></div>
    <button id="backToTopAudio" onclick="scrollToTop()">⬆ Kembali ke Atas</button>
  </div>

  <h2>Daftar File</h2>
  <ul id="file-list"></ul>

  <p><a href="uploads.html">Go to Uploads</a></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="script.js"></script>
<script>
  document.getElementById("user-nickname").textContent = localStorage.getItem("nickname");

  const MAX_SIZE = 100 * 1024 * 1024;

  function readFile(file, onProgress) {
    return new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onload = e => res(new Uint8Array(e.target.result));
      fr.onerror = e => rej(e);
      if (onProgress) {
        fr.onprogress = e => {
          if (e.lengthComputable) onProgress((e.loaded / e.total) * 100);
        };
      }
      fr.readAsArrayBuffer(file);
    });
  }

  // Konversi otomatis gambar apapun ke PNG valid
  async function toValidPNG(file) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        canvas.toBlob(blob => {
          const reader = new FileReader();
          reader.onload = e => resolve(new Uint8Array(e.target.result));
          reader.onerror = e => reject(e);
          reader.readAsArrayBuffer(blob);
        }, "image/png");
      };
      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });
  }

  async function makePolyglot(pngId, fileId, mode) {
    const pngFile = document.getElementById(pngId).files[0];
    const otherFile = document.getElementById(fileId).files[0];

    const msgBox = document.getElementById(
      mode === 'video' ? 'messageVideo' : mode === 'doc' ? 'messageDoc' : 'messageAudio'
    );
    const link = document.getElementById(
      mode === 'video' ? 'downloadVideo' : mode === 'doc' ? 'downloadDoc' : 'downloadAudio'
    );
    const progressBox = document.getElementById(
      mode === 'video' ? 'progressBoxVideo' : mode === 'doc' ? 'progressBoxDoc' : 'progressBoxAudio'
    );
    const bar = document.getElementById(
      mode === 'video' ? 'progressBarVideo' : mode === 'doc' ? 'progressBarDoc' : 'progressBarAudio'
    );
    const text = document.getElementById(
      mode === 'video' ? 'progressTextVideo' : mode === 'doc' ? 'progressTextDoc' : 'progressTextAudio'
    );

    msgBox.style.display = 'none';
    link.style.display = 'none';
    progressBox.style.display = 'block';
    bar.style.width = '0%';
    text.innerText = 'Progress: 0%';

    if (!pngFile || !otherFile) {
      msgBox.innerText = 'Pilih cover dan file kedua dulu.';
      msgBox.style.display = 'block';
      return;
    }
    if (pngFile.size > MAX_SIZE || otherFile.size > MAX_SIZE) {
      msgBox.innerText = 'Salah satu file melebihi 100 MB.';
      msgBox.style.display = 'block';
      return;
    }

    try {
      const pngBuf = await toValidPNG(pngFile);
      const otherBuf = await readFile(otherFile, p=>{
        bar.style.width = (p*0.7) + 30 + '%';
        text.innerText = `Progress: ${Math.round(30+p*0.7)}%`;
      });

      const out = new Uint8Array(pngBuf.length + otherBuf.length);
      out.set(pngBuf, 0);
      out.set(otherBuf, pngBuf.length);

      const blob = new Blob([out], {type:'image/png'});
      link.href = URL.createObjectURL(blob);
      link.style.display = 'inline-block';
      msgBox.innerText =
        'Polyglot berhasil dibuat. Download hasil lalu:\n- Buka langsung → tampil sebagai gambar\n- Rename jadi ekstensi asli ('+ otherFile.name.split('.').pop() +') → dibuka sebagai file';
      msgBox.style.display = 'block';
      bar.style.width = '100%';
      text.innerText = 'Progress: 100%';
    } catch (err) {
      msgBox.innerText = 'Error: ' + err.message;
      msgBox.style.display = 'block';
    }
  }

  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
</script>
</body>
</html>
